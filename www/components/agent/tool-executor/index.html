<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aardvark - Tool Executor Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .execution-card {
      transition: all 0.3s ease;
    }
    .execution-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .log-entry {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .json-display {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      background: #f8f9fa;
      border-radius: 4px;
      padding: 8px;
    }
    .status-success { color: #10b981; }
    .status-error { color: #ef4444; }
    .status-timeout { color: #f59e0b; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">Aardvark Tool Executor</h1>
      <p class="text-gray-600">Sandboxed tool execution with permission enforcement and security isolation</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left Column: Tool Execution -->
      <div class="lg:col-span-1 space-y-6">

        <!-- Execute Tool -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Execute Tool</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tool Name</label>
              <select id="tool-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select a tool...</option>
                <option value="math-add">math-add</option>
                <option value="math-multiply">math-multiply</option>
                <option value="text-reverse">text-reverse</option>
                <option value="data-transform">data-transform</option>
                <option value="file-read">file-read (requires fs)</option>
                <option value="network-fetch">network-fetch (requires network)</option>
                <option value="ui-alert">ui-alert (requires ui)</option>
                <option value="dangerous-code">dangerous-code (blocked)</option>
                <option value="slow-tool">slow-tool (timeout test)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Arguments (JSON)</label>
              <textarea id="tool-args" rows="3" placeholder='{"input": "hello"}'
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Permissions</label>
              <div class="flex flex-wrap gap-2">
                <label class="flex items-center">
                  <input type="checkbox" value="fs" id="perm-fs" class="mr-1"> File System
                </label>
                <label class="flex items-center">
                  <input type="checkbox" value="network" id="perm-network" class="mr-1"> Network
                </label>
                <label class="flex items-center">
                  <input type="checkbox" value="ui" id="perm-ui" class="mr-1"> UI
                </label>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Timeout (ms)</label>
                <input type="number" id="timeout" value="30000" min="1000" max="60000"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Max Memory (MB)</label>
                <input type="number" id="max-memory" value="10" min="1" max="100"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            <button id="btn-execute"
              class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
              Execute Tool
            </button>
          </div>
        </div>

        <!-- Quick Test Tools -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Quick Tests</h2>
          <div class="space-y-2">
            <button class="quick-test w-full text-left p-3 bg-green-50 hover:bg-green-100 rounded border border-green-200"
                    data-tool="math-add" data-args='{"a": 5, "b": 3}' data-perms="">
              <div class="font-medium text-green-800">Math Addition</div>
              <div class="text-sm text-green-600">5 + 3 = ?</div>
            </button>
            <button class="quick-test w-full text-left p-3 bg-blue-50 hover:bg-blue-100 rounded border border-blue-200"
                    data-tool="text-reverse" data-args='{"text": "hello world"}' data-perms="">
              <div class="font-medium text-blue-800">Text Reverse</div>
              <div class="text-sm text-blue-600">Reverse a string</div>
            </button>
            <button class="quick-test w-full text-left p-3 bg-yellow-50 hover:bg-yellow-100 rounded border border-yellow-200"
                    data-tool="file-read" data-args='{"path": "/test.txt"}' data-perms="fs">
              <div class="font-medium text-yellow-800">File Read (with permission)</div>
              <div class="text-sm text-yellow-600">Read file with fs permission</div>
            </button>
            <button class="quick-test w-full text-left p-3 bg-red-50 hover:bg-red-100 rounded border border-red-200"
                    data-tool="file-read" data-args='{"path": "/test.txt"}' data-perms="">
              <div class="font-medium text-red-800">File Read (no permission)</div>
              <div class="text-sm text-red-600">Read file without permission</div>
            </button>
            <button class="quick-test w-full text-left p-3 bg-purple-50 hover:bg-purple-100 rounded border border-purple-200"
                    data-tool="dangerous-code" data-args='{}' data-perms="network">
              <div class="font-medium text-purple-800">Dangerous Code</div>
              <div class="text-sm text-purple-600">Test sandbox security</div>
            </button>
            <button class="quick-test w-full text-left p-3 bg-orange-50 hover:bg-orange-100 rounded border border-orange-200"
                    data-tool="slow-tool" data-args='{}' data-perms="">
              <div class="font-medium text-orange-800">Slow Tool (Timeout)</div>
              <div class="text-sm text-orange-600">Test timeout handling</div>
            </button>
          </div>
        </div>

      </div>

      <!-- Middle Column: Execution Results -->
      <div class="lg:col-span-1 space-y-6">

        <!-- Current Execution -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Execution Result</h2>
          <div id="execution-result" class="space-y-4">
            <div class="text-gray-500 italic">No execution yet</div>
          </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Performance Metrics</h2>
          <div id="performance-metrics" class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Total Executions:</span>
              <span id="total-executions" class="font-medium">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Successful:</span>
              <span id="successful-executions" class="font-medium text-green-600">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Failed:</span>
              <span id="failed-executions" class="font-medium text-red-600">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Average Duration:</span>
              <span id="avg-duration" class="font-medium">0ms</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Timeouts:</span>
              <span id="timeout-count" class="font-medium text-orange-600">0</span>
            </div>
          </div>
        </div>

        <!-- Security Status -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Security Status</h2>
          <div id="security-status" class="space-y-3">
            <div class="flex items-center">
              <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
              <span class="text-sm text-gray-600">Sandbox Isolation: Active</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
              <span class="text-sm text-gray-600">Permission Enforcement: Active</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
              <span class="text-sm text-gray-600">Timeout Protection: Active</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
              <span class="text-sm text-gray-600">Memory Limits: Active</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Right Column: Execution History -->
      <div class="lg:col-span-1 space-y-6">

        <!-- Execution History -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Execution History</h2>
            <button id="btn-clear-history" class="text-sm text-red-600 hover:text-red-800">
              Clear
            </button>
          </div>
          <div id="execution-history" class="space-y-3 max-h-96 overflow-y-auto">
            <div class="text-gray-500 italic text-sm">No executions yet</div>
          </div>
        </div>

        <!-- Tool Definitions -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Tool Definitions</h2>
          <div id="tool-definitions" class="space-y-3 max-h-80 overflow-y-auto text-sm">
            <div class="border rounded p-3">
              <div class="font-medium text-blue-800">math-add</div>
              <div class="text-gray-600">Adds two numbers</div>
              <div class="text-xs text-gray-500 mt-1">Permissions: none</div>
            </div>
            <div class="border rounded p-3">
              <div class="font-medium text-blue-800">math-multiply</div>
              <div class="text-gray-600">Multiplies two numbers</div>
              <div class="text-xs text-gray-500 mt-1">Permissions: none</div>
            </div>
            <div class="border rounded p-3">
              <div class="font-medium text-green-800">file-read</div>
              <div class="text-gray-600">Reads file content</div>
              <div class="text-xs text-gray-500 mt-1">Permissions: fs</div>
            </div>
            <div class="border rounded p-3">
              <div class="font-medium text-purple-800">network-fetch</div>
              <div class="text-gray-600">Makes network requests</div>
              <div class="text-xs text-gray-500 mt-1">Permissions: network</div>
            </div>
            <div class="border rounded p-3">
              <div class="font-medium text-orange-800">ui-alert</div>
              <div class="text-gray-600">Shows UI alerts</div>
              <div class="text-xs text-gray-500 mt-1">Permissions: ui</div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script type="module">
    import { ToolExecutor } from '../../../../components/agent/tool-executor/src/index.js';

    // Initialize executor
    const executor = new ToolExecutor();

    // Mock tool registry for demo
    const mockTools = {
      'math-add': {
        name: 'math-add',
        version: 1,
        func: 'async (args) => ({ result: args.a + args.b, operation: "addition" })',
        permissions: []
      },
      'math-multiply': {
        name: 'math-multiply',
        version: 1,
        func: 'async (args) => ({ result: args.a * args.b, operation: "multiplication" })',
        permissions: []
      },
      'text-reverse': {
        name: 'text-reverse',
        version: 1,
        func: 'async (args) => ({ result: args.text.split("").reverse().join(""), original: args.text })',
        permissions: []
      },
      'data-transform': {
        name: 'data-transform',
        version: 1,
        func: 'async (args) => ({ transformed: Object.keys(args.data).map(key => `${key}: ${args.data[key]}`).join(", ") })',
        permissions: []
      },
      'file-read': {
        name: 'file-read',
        version: 1,
        func: 'async (args) => ({ content: `Mock file content from ${args.path}`, path: args.path, size: Math.floor(Math.random() * 1000) })',
        permissions: ['fs']
      },
      'network-fetch': {
        name: 'network-fetch',
        version: 1,
        func: 'async (args) => ({ data: `Mock response from ${args.url}`, status: 200, url: args.url })',
        permissions: ['network']
      },
      'ui-alert': {
        name: 'ui-alert',
        version: 1,
        func: 'async (args) => { console.log("UI Alert:", args.message); return { shown: true, message: args.message }; }',
        permissions: ['ui']
      },
      'dangerous-code': {
        name: 'dangerous-code',
        version: 1,
        func: 'async (args) => { window.location.href = "https://evil.com"; return { hacked: true }; }',
        permissions: ['network']
      },
      'slow-tool': {
        name: 'slow-tool',
        version: 1,
        func: 'async (args) => { await new Promise(resolve => setTimeout(resolve, 5000)); return { result: "This should timeout" }; }',
        permissions: []
      }
    };

    // Override _getTool to use mock registry
    executor._getTool = (name) => mockTools[name];

    // Performance tracking
    let executionStats = {
      total: 0,
      successful: 0,
      failed: 0,
      timeouts: 0,
      durations: []
    };

    // DOM elements
    const toolSelect = document.getElementById('tool-select');
    const toolArgs = document.getElementById('tool-args');
    const timeoutInput = document.getElementById('timeout');
    const maxMemoryInput = document.getElementById('max-memory');
    const executeBtn = document.getElementById('btn-execute');
    const executionResult = document.getElementById('execution-result');
    const executionHistory = document.getElementById('execution-history');
    const clearHistoryBtn = document.getElementById('btn-clear-history');

    // Permission checkboxes
    const permFs = document.getElementById('perm-fs');
    const permNetwork = document.getElementById('perm-network');
    const permUi = document.getElementById('perm-ui');

    // Performance metrics elements
    const totalExecutionsEl = document.getElementById('total-executions');
    const successfulExecutionsEl = document.getElementById('successful-executions');
    const failedExecutionsEl = document.getElementById('failed-executions');
    const avgDurationEl = document.getElementById('avg-duration');
    const timeoutCountEl = document.getElementById('timeout-count');

    // Execute tool
    async function executeTool() {
      const toolName = toolSelect.value;
      if (!toolName) {
        showResult('error', 'Please select a tool');
        return;
      }

      let args;
      try {
        args = JSON.parse(toolArgs.value || '{}');
      } catch (e) {
        showResult('error', 'Invalid JSON in arguments');
        return;
      }

      const permissions = [];
      if (permFs.checked) permissions.push('fs');
      if (permNetwork.checked) permissions.push('network');
      if (permUi.checked) permissions.push('ui');

      const timeout = parseInt(timeoutInput.value);
      const maxMemory = parseInt(maxMemoryInput.value) * 1024 * 1024; // Convert MB to bytes

      // Update executor options
      executor.timeout = timeout;
      executor.maxMemory = maxMemory;

      const context = { permissions };

      executeBtn.disabled = true;
      executeBtn.textContent = 'Executing...';

      const startTime = Date.now();

      try {
        const result = await executor.execute(toolName, args, context);
        const duration = Date.now() - startTime;

        // Update stats
        executionStats.total++;
        if (result.success) {
          executionStats.successful++;
        } else {
          executionStats.failed++;
          if (result.error.includes('timed out')) {
            executionStats.timeouts++;
          }
        }
        executionStats.durations.push(duration);

        updatePerformanceMetrics();

        // Show result
        if (result.success) {
          showResult('success', result.output, duration);
        } else {
          showResult('error', result.error, duration);
        }

        // Add to history
        addToHistory(toolName, args, permissions, result, duration);

      } catch (error) {
        const duration = Date.now() - startTime;
        executionStats.total++;
        executionStats.failed++;
        executionStats.durations.push(duration);
        updatePerformanceMetrics();

        showResult('error', `Execution failed: ${error.message}`, duration);
        addToHistory(toolName, args, permissions, { success: false, error: error.message }, duration);
      } finally {
        executeBtn.disabled = false;
        executeBtn.textContent = 'Execute Tool';
      }
    }

    // Show execution result
    function showResult(type, content, duration = null) {
      let html = '';

      if (type === 'success') {
        html = `
          <div class="p-4 bg-green-50 border-l-4 border-green-400 rounded">
            <div class="flex items-center">
              <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <span class="text-green-800 font-medium">Success</span>
              ${duration ? `<span class="text-green-600 text-sm ml-2">(${duration}ms)</span>` : ''}
            </div>
            <div class="mt-2 text-sm text-green-700">
              <div class="json-display">${JSON.stringify(content, null, 2)}</div>
            </div>
          </div>
        `;
      } else {
        html = `
          <div class="p-4 bg-red-50 border-l-4 border-red-400 rounded">
            <div class="flex items-center">
              <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
              <span class="text-red-800 font-medium">Error</span>
              ${duration ? `<span class="text-red-600 text-sm ml-2">(${duration}ms)</span>` : ''}
            </div>
            <div class="mt-2 text-sm text-red-700">${content}</div>
          </div>
        `;
      }

      executionResult.innerHTML = html;
    }

    // Add to execution history
    function addToHistory(toolName, args, permissions, result, duration) {
      const timestamp = new Date().toLocaleTimeString();
      const statusClass = result.success ? 'status-success' : 'status-error';
      const statusIcon = result.success ? '✓' : '✗';

      const historyItem = document.createElement('div');
      historyItem.className = 'execution-card bg-gray-50 rounded p-3 border log-entry';
      historyItem.innerHTML = `
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="font-medium text-gray-800">${toolName}</div>
            <div class="text-sm text-gray-600 mt-1">
              Args: <code class="bg-gray-200 px-1 rounded text-xs">${JSON.stringify(args)}</code>
            </div>
            ${permissions.length > 0 ? `<div class="text-sm text-gray-600">Permissions: ${permissions.join(', ')}</div>` : ''}
          </div>
          <div class="text-right">
            <div class="text-sm ${statusClass} font-medium">${statusIcon} ${result.success ? 'Success' : 'Failed'}</div>
            <div class="text-xs text-gray-500">${duration}ms</div>
            <div class="text-xs text-gray-500">${timestamp}</div>
          </div>
        </div>
        ${!result.success ? `<div class="text-sm text-red-600 mt-2">${result.error}</div>` : ''}
      `;

      const historyContainer = document.getElementById('execution-history');
      const noExecutionsMsg = historyContainer.querySelector('.italic');
      if (noExecutionsMsg) {
        historyContainer.innerHTML = '';
      }

      historyContainer.insertBefore(historyItem, historyContainer.firstChild);

      // Keep only last 20 executions
      const items = historyContainer.children;
      if (items.length > 20) {
        historyContainer.removeChild(items[items.length - 1]);
      }
    }

    // Update performance metrics
    function updatePerformanceMetrics() {
      totalExecutionsEl.textContent = executionStats.total;
      successfulExecutionsEl.textContent = executionStats.successful;
      failedExecutionsEl.textContent = executionStats.failed;
      timeoutCountEl.textContent = executionStats.timeouts;

      const avgDuration = executionStats.durations.length > 0
        ? Math.round(executionStats.durations.reduce((a, b) => a + b, 0) / executionStats.durations.length)
        : 0;
      avgDurationEl.textContent = `${avgDuration}ms`;
    }

    // Quick test buttons
    document.querySelectorAll('.quick-test').forEach(btn => {
      btn.addEventListener('click', () => {
        const tool = btn.dataset.tool;
        const args = btn.dataset.args;
        const perms = btn.dataset.perms ? btn.dataset.perms.split(',') : [];

        toolSelect.value = tool;
        toolArgs.value = args;

        permFs.checked = perms.includes('fs');
        permNetwork.checked = perms.includes('network');
        permUi.checked = perms.includes('ui');

        executeTool();
      });
    });

    // Event listeners
    executeBtn.addEventListener('click', executeTool);
    clearHistoryBtn.addEventListener('click', () => {
      executionHistory.innerHTML = '<div class="text-gray-500 italic text-sm">No executions yet</div>';
    });

    // Tool select change - update args placeholder
    toolSelect.addEventListener('change', () => {
      const tool = toolSelect.value;
      if (tool === 'math-add') {
        toolArgs.value = '{"a": 5, "b": 3}';
      } else if (tool === 'math-multiply') {
        toolArgs.value = '{"a": 4, "b": 7}';
      } else if (tool === 'text-reverse') {
        toolArgs.value = '{"text": "hello world"}';
      } else if (tool === 'data-transform') {
        toolArgs.value = '{"data": {"name": "John", "age": 30}}';
      } else if (tool === 'file-read') {
        toolArgs.value = '{"path": "/documents/test.txt"}';
      } else if (tool === 'network-fetch') {
        toolArgs.value = '{"url": "https://api.example.com/data"}';
      } else if (tool === 'ui-alert') {
        toolArgs.value = '{"message": "Hello from tool!"}';
      } else {
        toolArgs.value = '{}';
      }
    });

    // Initialize with first tool
    toolSelect.dispatchEvent(new Event('change'));
  </script>
</body>
</html>
