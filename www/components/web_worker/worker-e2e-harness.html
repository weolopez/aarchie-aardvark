<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Worker E2E Harness</title>
  <style>
    body { font-family: monospace; background: #f8f8f8; margin: 2em; }
    #log { background: #fff; border: 1px solid #ccc; padding: 1em; height: 400px; overflow: auto; }
    input, button { font-size: 1em; }
  </style>
</head>
<body>
  <h2>Web Worker E2E Test Harness</h2>
  <div>
    <label>API Key: <input id="apiKey" type="text" size="50"></label>
    <label>Model: <input id="model" type="text" value="gemini-3-flash-preview"></label>
    <button id="initBtn">Init Worker</button>
  </div>
  <div style="margin-top:1em;">
    <input id="userMsg" type="text" size="60" placeholder="Type a message...">
    <button id="sendBtn">Send Chat</button>
  </div>
  <pre id="log"></pre>
  <script>
    let worker;
    let sessionId = 'test-session';
    const log = (msg) => {
      document.getElementById('log').textContent += msg + '\n';
    };
    document.getElementById('initBtn').onclick = () => {
      if (worker) worker.terminate();
      worker = new Worker('../../../src/agent/worker.js', { type: 'module' });
      worker.onmessage = (e) => {
        log('[Worker message] ' + JSON.stringify(e.data));
      };
      worker.onerror = (e) => {
        log('[Worker error] ' + e.message);
      };
      // Send init after worker loads
      setTimeout(() => {
        worker.postMessage({
          type: 'init',
          id: 'test-init',
          payload: {
            apiKey: document.getElementById('apiKey').value,
            provider: 'gemini',
            model: document.getElementById('model').value,
            temperature: 0.7,
            systemInstruction: 'You are a helpful AI assistant. Answer questions directly and factually.',
            maxTokens: 4096
          }
        });
      }, 500);
    };
    document.getElementById('sendBtn').onclick = () => {
      if (!worker) return log('Worker not initialized!');
      const msg = document.getElementById('userMsg').value;
      worker.postMessage({
        type: 'chat',
        id: 'test-chat',
        payload: {
          message: msg,
          sessionId
        }
      });
    };
  </script>
</body>
</html>
