<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tool Registry Unit Tests</title>
</head>
<body>
    <div id="test-results"></div>

    <script type="module">
        import { ToolRegistry } from '../../src/index.js';

        class TestRunner {
            constructor() {
                this.tests = [];
                this.passCount = 0;
                this.failCount = 0;
            }

            test(name, fn) {
                this.tests.push({ name, fn });
            }

            async runAll() {
                const container = document.getElementById('test-results');

                for (const test of this.tests) {
                    const el = document.createElement('div');
                    container.appendChild(el);
                    try {
                        await test.fn();
                        this.passCount++;
                        el.style.color = 'green';
                        el.textContent = `✓ ${test.name}`;
                    } catch (error) {
                        this.failCount++;
                        el.style.color = 'red';
                        el.textContent = `✗ ${test.name}: ${error.message}`;
                        console.error(error);
                    }
                }

                const summary = document.createElement('div');
                summary.style.fontWeight = 'bold';
                summary.style.marginTop = '20px';
                summary.textContent = `Tests completed: ${this.passCount} passed, ${this.failCount} failed`;
                container.appendChild(summary);
                
                // Add status badge for test runner
                const badge = document.createElement('div');
                badge.id = 'status-badge';
                badge.style.display = 'none';
                badge.textContent = this.failCount === 0 ? 'All Tests Passed!' : 'Tests Failed';
                document.body.appendChild(badge);
                
                const total = document.createElement('div'); total.id = 'total-count'; total.textContent = this.tests.length;
                const pass = document.createElement('div'); pass.id = 'pass-count'; pass.textContent = this.passCount;
                const fail = document.createElement('div'); fail.id = 'fail-count'; fail.textContent = this.failCount;
                document.body.append(total, pass, fail);
            }
        }

        const runner = new TestRunner();

        runner.test('should register a valid tool', () => {
            const registry = new ToolRegistry();
            const tool = {
                id: 'test-id',
                name: 'test_tool',
                version: 1,
                func: 'async () => "test"',
                schema: { type: 'object', properties: {} },
                type: 'system',
                permissions: [],
                created: new Date().toISOString()
            };

            registry.register(tool);
            expect(registry.has('test_tool')).toBe(true);
            expect(registry.get('test_tool')).toEqual(tool);
        });

        runner.test('should throw on invalid tool', () => {
            const registry = new ToolRegistry();
            const invalidTool = { name: 'test' };
            expect(() => registry.register(invalidTool)).toThrow();
        });

        runner.test('should throw on duplicate name', () => {
            const registry = new ToolRegistry();
            const tool = {
                id: 'test-id',
                name: 'test_tool',
                version: 1,
                func: 'async () => "test"',
                schema: { type: 'object', properties: {} },
                type: 'system',
                permissions: [],
                created: new Date().toISOString()
            };

            registry.register(tool);
            expect(() => registry.register(tool)).toThrow();
        });

        runner.test('should unregister an existing tool', () => {
            const registry = new ToolRegistry();
            const tool = {
                id: 'test-id',
                name: 'test_tool',
                version: 1,
                func: 'async () => "test"',
                schema: { type: 'object', properties: {} },
                type: 'system',
                permissions: [],
                created: new Date().toISOString()
            };

            registry.register(tool);
            registry.unregister('test_tool');
            expect(registry.has('test_tool')).toBe(false);
        });

        runner.test('should throw on unregistering non-existent tool', () => {
            const registry = new ToolRegistry();
            expect(() => registry.unregister('nonexistent')).toThrow();
        });

        runner.test('should list all tools', () => {
            const registry = new ToolRegistry();
            const tool1 = {
                id: 'id1',
                name: 'tool1',
                version: 1,
                func: 'async () => "1"',
                schema: { type: 'object', properties: {} },
                type: 'system',
                permissions: [],
                created: new Date().toISOString()
            };

            const tool2 = {
                id: 'id2',
                name: 'tool2',
                version: 1,
                func: 'async () => "2"',
                schema: { type: 'object', properties: {} },
                type: 'system',
                permissions: [],
                created: new Date().toISOString()
            };

            registry.register(tool1);
            registry.register(tool2);

            const tools = registry.list();
            expect(tools).toHaveLength(2);
            expect(tools.map(t => t.name)).toEqual(['tool1', 'tool2']);
        });

        runner.test('should return undefined for non-existent tool', () => {
            const registry = new ToolRegistry();
            expect(registry.get('nonexistent')).toBeUndefined();
        });

        runner.test('should emit tool:registered event', () => {
            const registry = new ToolRegistry();
            const tool = {
                id: 'test-id',
                name: 'test_tool',
                version: 1,
                func: 'async () => "test"',
                schema: { type: 'object', properties: {} },
                type: 'system',
                permissions: [],
                created: new Date().toISOString()
            };

            let emitted = false;
            registry.on('tool:registered', (registeredTool) => {
                emitted = true;
                expect(registeredTool).toEqual(tool);
            });

            registry.register(tool);
            expect(emitted).toBe(true);
        });

        runner.test('should allow unsubscribing from events', () => {
            const registry = new ToolRegistry();
            let callCount = 0;
            const handler = () => callCount++;

            const unsubscribe = registry.on('tool:registered', handler);
            unsubscribe();

            const tool = {
                id: 'test-id',
                name: 'test_tool',
                version: 1,
                func: 'async () => "test"',
                schema: { type: 'object', properties: {} },
                type: 'system',
                permissions: [],
                created: new Date().toISOString()
            };

            registry.register(tool);
            expect(callCount).toBe(0);
        });

        // Simple expect function for tests
        function expect(actual) {
            return {
                toBe(expected) {
                    if (actual !== expected) {
                        throw new Error(`Expected ${expected}, got ${actual}`);
                    }
                },
                toEqual(expected) {
                    if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeUndefined() {
                    if (actual !== undefined) {
                        throw new Error(`Expected undefined, got ${actual}`);
                    }
                },
                toHaveLength(expected) {
                    if (actual.length !== expected) {
                        throw new Error(`Expected length ${expected}, got ${actual.length}`);
                    }
                },
                toThrow(expected) {
                    try {
                        actual();
                        throw new Error('Expected function to throw');
                    } catch (error) {
                        if (expected && !(error.message.includes(expected))) {
                            throw new Error(`Expected error containing "${expected}", got "${error.message}"`);
                        }
                    }
                }
            };
        }

        // Run tests when page loads
        window.addEventListener('load', () => {
            runner.runAll();
        });
    </script>
</body>
</html>
